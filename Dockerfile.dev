# EquiML - Development Docker Image
# Optimized for development with Jupyter, debugging tools, and hot reload

FROM python:3.11-slim

# Set environment variables for development
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    DEVELOPMENT=1

# Install system dependencies including development tools
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    vim \
    htop \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements
COPY requirements.txt pyproject.toml setup.py ./

# Install all dependencies including development tools
RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install jupyter jupyterlab notebook && \
    pip install ipython ipdb && \
    pip install black isort autopep8 && \
    pip install pytest pytest-cov flake8 mypy bandit safety

# Install optional ML dependencies for development
RUN pip install xgboost lightgbm optuna || echo "Some ML packages may not install on all platforms"

# Copy all source code
COPY . .

# Install EquiML in development mode
RUN pip install -e .

# Create development directories
RUN mkdir -p /app/notebooks /app/experiments /app/outputs /app/logs

# Set up Jupyter configuration
RUN jupyter --generate-config && \
    echo "c.NotebookApp.ip = '0.0.0.0'" >> ~/.jupyter/jupyter_notebook_config.py && \
    echo "c.NotebookApp.port = 8888" >> ~/.jupyter/jupyter_notebook_config.py && \
    echo "c.NotebookApp.open_browser = False" >> ~/.jupyter/jupyter_notebook_config.py && \
    echo "c.NotebookApp.allow_root = True" >> ~/.jupyter/jupyter_notebook_config.py

# Expose ports
EXPOSE 8888 8501 8000

# Default to Jupyter Lab for development
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token=''"]

LABEL purpose="development" \
      includes="jupyter,debugging-tools,all-dependencies"